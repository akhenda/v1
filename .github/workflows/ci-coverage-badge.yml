name: Coverage Badge

on: workflow_call

jobs:
  code-coverage-badge:
    name: Code Coverage
    runs-on: ubuntu-latest
    steps:
      - name: üèóÔ∏è Create a few directories
        run: |
          mkdir apps
          mkdir packages
          mkdir tooling

      - name: ‚§µÔ∏è Download artifact (base code coverage results)
        if: github.event_name == 'pull_request'
        uses: dawidd6/action-download-artifact@v7
        id: restored-base-code-coverage
        continue-on-error: true
        with:
          workflow: merge.yml
          workflow_conclusion: success
          branch: dev
          name: coverage
          path: coverage-base
          if_no_artifact_found: ignore

      - name: ‚§µÔ∏è Download code coverage results
        uses: actions/download-artifact@v4
        id: restored-code-coverage
        continue-on-error: true
        with:
          name: coverage
          path: .
          merge-multiple: true

      - name: üìã Display structure of downloaded files
        run: ls -R

      - name: üñ•Ô∏è Debug Secrets
        env:
          DEBUG_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEBUG_COVERAGE_BADGES_GIST_TOKEN: ${{ secrets.COVERAGE_BADGES_GIST_TOKEN }}
          DEBUG_GIST_SECRET: ${{ secrets.GIST_SECRET }}
          DEBUG_NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo ${#DEBUG_GITHUB_TOKEN}
          echo ${#DEBUG_COVERAGE_BADGES_GIST_TOKEN}
          echo ${#DEBUG_GIST_SECRET}
          echo ${#DEBUG_NPM_TOKEN}

      # https://github.com/marketplace/actions/code-coverage-with-reviewdog
      - name: üìî Apps code coverage report
        uses: hokify/code-coverage-assistant-ts@v2.5
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          monorepo-base-path: './apps'

      - name: üìî Packages code coverage report
        uses: hokify/code-coverage-assistant-ts@v2.5
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          monorepo-base-path: './packages'

      - name: üìî Tooling code coverage report
        uses: hokify/code-coverage-assistant-ts@v2.5
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          monorepo-base-path: './tooling'
